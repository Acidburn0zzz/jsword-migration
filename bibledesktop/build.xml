<project name="bibledesktop" default="all">

  <!-- This build uses the core build targets -->
  <import file="../common/core.xml"/>
  <property name="dependency"       value="jsword"/>
  <property name="dependency.jar"   value="../${dependency}/target/ant/jar"/>

  <!--=======================================================================-->
  <property name="gener.root"       value="target/gener"/>
  <property name="target.jnlp"      value="${target.root}/bibledesktop"/>
  <property name="target.installed" value="${target.root}/installed"/>
  <!-- The following works on Windows. Others may need file:// -->
  <property name="file.protocol" value="file:///"/>
  <property name="jnlp.local.hostname" value="${file.protocol}${basedir}/${target.root}"/>
  <property name="jnlp.local.location" value="installed"/>

  <!--=======================================================================-->
  <target name="testcompile.extra">
    <mkdir dir="${gener.root}/config"/>
    <style
        in="${source.res}/config.xml"
        out="${gener.root}/config/ConfigTest.java"
        style="../common/etc/config-test.xsl"/>
    <javac debug="on" includes="**/*.java" destdir="${test.classes}">
      <src path="${gener.root}/config"/>
      <classpath refid="test.jarpath"/>
    </javac>
  </target>

  <!--=======================================================================-->
  <target name="install" depends="build, keygen" description="Prepares for web based jnlp deploy" >
	<!-- sign the jars to a temporary location so they can be reused -->
    <jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="bibledesktop.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="common.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="commons-lang-2.0.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="commons-net-1.1.0.jar"/>
  	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="jsword.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="jdom.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="jlfgr-1_0.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="log4j-1.2.8.jar"/>
	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="lucene-1.3-final.jar"/>
  	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="tar.jar"/>
  	<jar.sign srcdir="${target.jar}" destdir="${target.signed}" jar="winlaf-0.4.jar"/>

    <!-- Copy the files needed for the distribution -->
    <mkdir dir="${target.jnlp}"/>
    <copy todir="${target.jnlp}">
      <fileset dir="${target.signed}"/>
      <fileset dir="${source.etc}/jnlp" includes="${ant.project.name}.jnlp"/>
      <fileset dir="${source.etc}/bin"/>
    </copy>
    <chmod perm="a+x">
      <fileset dir="${target.jnlp}">
        <include name="**/*.sh"/>
      </fileset>
    </chmod>
    <fixcrlf srcdir="${target.jnlp}" eol="lf">
      <include name="**/*.sh"/>
    </fixcrlf>
    <fixcrlf srcdir="${target.jnlp}" eol="crlf">
      <include name="**/*.bat"/>
    </fixcrlf>
    <!--
    Attempt a local deploy, we might be able to get the jnlp file to work
    locally on a relative path, but in the mean time there is always the *.bat
    and *.sh startup files.
    -->
    <mkdir dir="${target.installed}"/>
    <copy todir="${target.installed}" filtering="true">
      <fileset dir="${target.jnlp}">
        <include name="**/*.jnlp"/>
      </fileset>
      <filterset>
        <filter token="HOSTNAME" value="${jnlp.local.hostname}"/>
        <filter token="WEBAPP" value="${jnlp.local.location}"/>
      </filterset>
    </copy>
    <copy todir="${target.installed}" filtering="false">
      <fileset dir="${target.jnlp}">
        <exclude name="**/*.jnlp"/>
      </fileset>
    </copy>
  </target>

</project>
